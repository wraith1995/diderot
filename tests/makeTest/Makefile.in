#config vars:
SHELL = {shell}
PYTHON = {python}
PYTHONINCLUDE = {pythonIncludes}
DIDEROTFEMPATH = {diderotPath}
TEEMPATH = {teemPath}
TARGET = {programName}
NAMESPACE = $(TARGET)
CC = clang
CXX = clang++ -std=gnu++11
PYTHONDATA = runData.py
PYTHONSTAT = runStatic.py

DIDEROTFEM = $(DIDEROTFEMPATH)/bin/diderotc
DIDEROTINCLUDE = $(DIDEROTFEMPATH)/include
DIDEROTLIB = $(DIDEROTFEMPATH)/lib
TEEMLIB = $(TEEMPATH)/include

DIDEROTFLAGS = --debug --log --json --dump-pt --dump-ast --dump-simple --dump-high --dump-mid --dump-low --dump-tree --double --namespace=$(NAMESPACE) 
INCLUDES = -I$(DIDEROTINCLUDE) -I/usr/local/include -I$(TEEMLIB) -I$(PYTHONINCLUDE)
LDFLAGS = -L$(DIDEROTLIB) -L/usr/local/lib -L/opt/local/lib -L/usr/lib
LIBS = -lteem -lpng -lz -lbz2
CPPFLAGS = $(INCLUDES) -g O2 -fPIC
CXXFLAGS = $(INCLUDES) -g -fPIC

ifeq ($(PARALLEL),yes)
PTHREAD_FLAGS =	-D_THREAD_SAFE 
PTHREAD_LIBS =	
else
PTHREAD_FLAGS =
PTHREAD_LIBS =
endif


$(TARGET).cxx $(TARGET).h $(TARGET).o $(TARGET).so $(TARGET).json: $(TARGET).diderot $(DIDEROTFEM)
	$(DIDEROTFEM) $(DIDEROTFLAGS) $(TARGET).diderot

build: $(TARGET).so

run: $(TARGET).so $(PYTHONDATA)
	$(PYTHON) $(PYTHONDATA)
saveRun: $(TARGET).so $(PYTHONDATA) $(PYTHONSTAT)
	$(PYTHON) $(PYTHONDATA) -s
	$(PYTHON) $(PYTHONSTAT)
clean:
	rm -f $(TARGET).cxx $(TARGET).h $(TARGET).o $(TARGET).so $(TARGET).json $(TARGET).h.cffi $(TARGET)_wrap.o $(TARGET)_wrap.c _$(TARGET).so $(TARGET).py $(TARGET).

runJson: $(PYTHONDATA)
	$(PYTHON) $(PYTHONDATA)
